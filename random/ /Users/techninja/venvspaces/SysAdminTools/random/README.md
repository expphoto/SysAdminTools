CertDeploy - SSL Certificate Renewal and IIS Deployment Automation Tool`n`n## Overview`n`nCertDeploy is a PowerShell-based automation tool that manages SSL certificate renewal packaging and IIS deployment across domain-joined Windows servers without requiring RDP access. It provides safe modes including audit/report-only, test mode, and deploy mode with automatic rollback.`n`n## Features`n`n- **Automated Certificate Packaging**: Export PFX from CA server, store in share structure, maintain archive`n- **Remote IIS Deployment**: Import certificates and update bindings across multiple servers via WinRM`n- **GoDaddy Integration**: Download renewed certificates via GoDaddy API (optional)`n- **Safe Operation Modes**:`n  - `audit`: Read-only enumeration and reporting`n  - `package`: Export and package certificates to the share`n  - `deploy`: Deploy certificates with health checks and rollback`n  - `verify`: Confirm deployment across all targets`n  - `report`: Generate ticket-ready summary`n- **Health Checks**: Verify endpoints after certificate swap with automatic rollback`n- **Structured Logging**: JSON logs + human-readable console output`n- **Safety Features**: WhatIf support, confirmation prompts, test mode`n`n## Prerequisites`n`n### Required on Runner Machine`n`n- Windows PowerShell 5.1 or higher`n- WebAdministration module (IIS management)`n- WinRM enabled for remote access`n- Domain-joined workstation with appropriate permissions`n- Access to certificate share: `\\<certShareServer>\certificates\``n`n### Required on Target Servers`n`n- Windows Server with IIS`n- WinRM enabled and accessible from runner`n- Domain-joined`n- Local Administrator or delegated permissions for IIS certificate management`n`n### Required on CA Server`n`n- Windows Server with certificate authority`n- WinRM enabled`n- Access to exportable certificates with private keys`n`n### Permissions`n`n- Read/Write access to certificate share UNC path`n- Remote PowerShell (WinRM) access to CA server and target servers`n- Local Administrator rights or IIS administration delegation on targets`n- Certificate export permissions on CA server`n`n## Installation`n`n1. Place `CertDeploy.ps1` and `CertDeploy-config.json` in your working directory`n2. Configure `CertDeploy-config.json` for your environment`n3. Ensure WinRM is enabled: `winrm quickconfig``n4. Test connectivity: `winrs -r <target> hostname``n`n## Configuration`n`nThe `CertDeploy-config.json` file contains:`n`n### GlobalSettings`n`n- `CAServer`: FQDN of the certificate authority server`n- `CertShareUNC`: UNC path to certificate share root`n- `DefaultPFXPasswordMode`: `Prompt` (default) or `DPAPI``n- `LoggingPath`: Directory for JSON log files`n- `StagingPath`: Directory for manual certificate staging`n- `TestModeServers`: Array of server names for test mode deployments`n- `ExpirationWarningDays`: Array of warning thresholds (default: 30, 60, 90)`n`n### GoDaddy`n`n- `Enabled`: `true` to use GoDaddy API`n- `ApiKey`: GoDaddy API key`n- `ApiSecret`: GoDaddy API secret`n- `ShopperId`: GoDaddy shopper ID`n- `UseV2Api`: `true` for v2 API endpoints`n`n### Certificates`n`nArray of certificate entries, each with:`n`n- `FriendlyName`: Unique identifier (becomes folder name)`n- `ExpectedDomains`: Array of domains that should be in certificate`n- `GoDaddy.CertificateId`: GoDaddy certificate ID (for API download)`n- `GoDaddy.EntitlementId`: GoDaddy entitlement ID (alternative)`n- `Targets`: Array of target servers with IIS site bindings`n`n## Usage`n`n### Command Syntax`n`n```powershell`n.\CertDeploy.ps1 -Command <command> [-FriendlyName <name>] [-Server <server>] [-TestMode] [-WhatIf] [-ExportJson] [-LogPath <path>]`n````n`n### Commands`n`n#### audit`n`nEnumerate certificates, IIS bindings, and expirations across all targets.`n`n```powershell`n# Audit all certificates`n.\CertDeploy.ps1 -Command audit`n`n# Audit specific certificate`n.\CertDeploy.ps1 -Command audit -FriendlyName webapp-frontend`n`n# Audit single server`n.\CertDeploy.ps1 -Command audit -Server WEB01.domain.local`n````n`n**Output includes:**`n`n- Current certificate thumbprints and expiry dates`n- IIS bindings per site`n- Certificate mismatch warnings`n- Expiration alerts (30/60/90 days)`n`n#### package`n`nExport PFX from CA server and package to the share.`n`n```powershell`n# Package certificate (prompts for password)`n.\CertDeploy.ps1 -Command package -FriendlyName webapp-frontend`n`n# WhatIf mode - show what would happen`n.\CertDeploy.ps1 -Command package -FriendlyName webapp-frontend -WhatIf`n`n# With staging folder (manual GoDaddy download)`n# Place files in .\staging\webapp-frontend\ then run:`n.\CertDeploy.ps1 -Command package -FriendlyName webapp-frontend -StagingPath .\staging`n````n`n**Process:**`n`n1. Downloads from GoDaddy API (if configured) OR queries CA server`n2. Validates certificate (expiry, private key, SANs)`n3. Exports PFX with private key and full chain`n4. Moves existing `current.pfx` to `archive\previous.pfx``n5. Writes new PFX to `\\share\certificates\<FriendlyName>\current.pfx``n`n#### deploy`n`nDeploy certificate to target servers and update IIS bindings.`n`n```powershell`n# Deploy to all targets`n.\CertDeploy.ps1 -Command deploy -FriendlyName webapp-frontend`n`n# Test mode - import cert but don't change bindings on prod servers`n.\CertDeploy.ps1 -Command deploy -FriendlyName webapp-frontend -TestMode`n`n# WhatIf - preview changes`n.\CertDeploy.ps1 -Command deploy -FriendlyName webapp-frontend -WhatIf`n`n# Deploy to single server`n.\CertDeploy.ps1 -Command deploy -FriendlyName webapp-frontend -Server WEB01.domain.local`n`n# Skip health checks`n.\CertDeploy.ps1 -Command deploy -FriendlyName webapp-frontend -SkipHealthCheck`n````n`n**Process:**`n`n1. Imports PFX to LocalMachine\My store on each target`n2. Updates IIS bindings to new thumbprint`n3. Runs health check URL (if configured)`n4. If health check fails: auto-rollback to old thumbprint`n`n#### verify`n`nVerify that the correct certificate is deployed and active on all targets.`n`n```powershell`n# Verify all targets for a certificate`n.\CertDeploy.ps1 -Command verify -FriendlyName webapp-frontend`n`n# Verify single server`n.\CertDeploy.ps1 -Command verify -FriendlyName webapp-frontend -Server WEB01.domain.local`n````n`n**Output includes:**`n`n- Current binding thumbprint vs expected`n- Health check results (if configured)`n- Match status per site`n`n#### report`n`nGenerate a comprehensive report suitable for ticket notes.`n`n```powershell`n# Generate report`n.\CertDeploy.ps1 -Command report`n`n# Export report to JSON`n.\CertDeploy.ps1 -Command report -ExportJson`n`n# Export to specific file`n.\CertDeploy.ps1 -Command report -ExportJson .\report.json`n````n`n**Report includes:**`n`n- Summary of all certificates`n- Critical findings (expiring certificates)`n- Mismatched bindings`n- Recommended actions`n`n### Self-Test`n`nRun a self-test to validate prerequisites and connectivity.`n`n```powershell`n.\CertDeploy.ps1 -Command self-test`n````n`n## File Share Structure`n`nThe tool maintains this structure:`n`n```
\\certshare.domain.local\certificates\`n└── <FriendlyName>/`n    ├── current.pfx           # Active certificate`n    └── archive/              # Previous year's certificate`n        └── previous.pfx      # Last active certificate`n````n`n`n**Important:**`n`n- Date-based folders are NOT created`n- Archive overwrites prior archive`n- Only current and archive folders exist`n`n## GoDaddy Integration`n`n### API Configuration`n`nUpdate `CertDeploy-config.json`:`n`n```json`n"GoDaddy": {`n  "Enabled": true,`n  "ApiKey": "your-api-key",`n  "ApiSecret": "your-api-secret",`n  "ShopperId": "your-shopper-id",`n  "UseV2Api": false`n}`n````n`n### Manual Staging`n`nIf API credentials are NOT provided:`n`n1. Download certificate bundle from GoDaddy web UI`n2. Extract files to `.\staging\<FriendlyName>\``n3. Run package command: `.\CertDeploy.ps1 -Command package -FriendlyName <FriendlyName>``n`n`n## Security`n`n### Password Modes`n`n**Prompt (default):**`n```powershell`n# Prompts at runtime`n.\CertDeploy.ps1 -Command deploy -FriendlyName webapp-frontend`nEnter PFX password: ********`n````n`n**DPAPI:**`n`nPassword is encrypted at rest using DPAPI tied to the user/machine. Requires configuration in `CertDeploy-config.json`:`n`n```json`n"DefaultPFXPasswordMode": "DPAPI"`n````n`n### Secrets Safety`n`n- Passwords are never logged`n- PFX content is transmitted via WinRM (not stored in clear text on targets)`n- Logs contain only thumbprints, not passwords`n`n## Common Workflows`n`n### Complete Certificate Renewal`n`n```powershell`n# 1. Audit current state`n.\CertDeploy.ps1 -Command audit -FriendlyName webapp-frontend`n`n# 2. Package the renewed certificate`n.\CertDeploy.ps1 -Command package -FriendlyName webapp-frontend`n`n# 3. Test deployment on test servers`n.\CertDeploy.ps1 -Command deploy -FriendlyName webapp-frontend -TestMode`n`n# 4. Verify test deployment`n.\CertDeploy.ps1 -Command verify -FriendlyName webapp-frontend`n`n# 5. Deploy to production`n.\CertDeploy.ps1 -Command deploy -FriendlyName webapp-frontend`n`n# 6. Verify production deployment`n.\CertDeploy.ps1 -Command verify -FriendlyName webapp-frontend`n`n# 7. Generate report for ticket`n.\CertDeploy.ps1 -Command report -ExportJson .\renewal-report.json`n````n`n### Quick Audit for Expiring Certificates`n`n```powershell`n# Find all certificates expiring soon`n.\CertDeploy.ps1 -Command audit -ExportJson .\audit-results.json`n`n# Check results`n$results = Get-Content .\audit-results.json | ConvertFrom-Json`n$results.Summary`n`n# Get critical findings`n$results.Details | ForEach-Object {`n  $_.Findings | Where-Object { $_.Severity -eq "Critical" }`n}`n````n`n### Bulk Deployment with Verification`n`n```powershell`n# Deploy multiple certificates`n$certs = @("webapp-frontend", "api-gateway", "wildcard-domain")`n`nforeach ($cert in $certs) {`n  .\CertDeploy.ps1 -Command deploy -FriendlyName $cert`n  .\CertDeploy.ps1 -Command verify -FriendlyName $cert`n}`n````n`n## Troubleshooting`n`n### WinRM Connection Issues`n`n**Problem:** Cannot connect to target servers`n`n`n**Solutions:**`n`n```powershell`n# Check WinRM status on runner`nwinrm quickconfig`n`n# Test connectivity to specific server`nTest-WSMan -ComputerName WEB01.domain.local`n`n# Add target to trusted hosts (if in different domain/workgroup)`nSet-Item WSMan:\localhost\Client\TrustedHosts -Value "WEB01.domain.local" -Force`n`n# Check WinRM on target`nInvoke-Command -ComputerName WEB01.domain.local -ScriptBlock { winrm quickconfig }`n````n`n### IIS Module Not Available`n`n**Problem:** WebAdministration module not found`n`n`n**Solutions:**`n`n```powershell`n# Check if module is installed`nGet-Module -ListAvailable -Name WebAdministration`n`n# Install IIS Management Tools (if on Windows)`n# Server Manager -> Add Roles -> Web Server (IIS) -> Management Tools`n`n# Import manually`nImport-Module WebAdministration`n````n`n### Certificate Export Failed`n`n**Problem:** Cannot export PFX from CA server`n`n`n**Solutions:**`n`n1. Verify certificate has exportable private key`n2. Check that you have permissions to export`n3. Verify WinRM connectivity to CA server`n4. Check certificate store: `Cert:\LocalMachine\My``n`n`n```powershell`n# Check certificate on CA server`nInvoke-Command -ComputerName CA01.domain.local -ScriptBlock {`n  Get-ChildItem Cert:\LocalMachine\My | Where-Object { $_.FriendlyName -eq "webapp-frontend" }`n}`n````n`n### Binding Update Failed`n`n**Problem:** Cannot update IIS binding`n`n`n**Solutions:**`n`n```powershell`n# Check existing bindings on target`nInvoke-Command -ComputerName WEB01.domain.local -ScriptBlock {`n  Import-Module WebAdministration`n  Get-WebBinding -Name "Default Web Site" -Protocol https`n}`n`n# Verify certificate is in store`nInvoke-Command -ComputerName WEB01.domain.local -ScriptBlock {`n  Get-ChildItem Cert:\LocalMachine\My`n}`n`n# Check IIS application pool identity permissions`n# Private key must be readable by IIS AppPool identity`n````n`n### Health Check Failed`n`n**Problem:** Health check URL returns error or timeout`n`n`n**Solutions:**`n`n1. Verify the health check URL is accessible from the runner`n2. Check that the certificate is valid (chain, expiry)`n3. Verify DNS resolves correctly`n4. Check firewall rules`n5. Use `-SkipHealthCheck` to bypass temporarily`n`n```powershell`n# Test URL manually`nInvoke-WebRequest -Uri "https://webapp.domain.com/health" -UseBasicParsing`n`n# Skip health check`n.\CertDeploy.ps1 -Command deploy -FriendlyName webapp-frontend -SkipHealthCheck`n````n`n### Certificate Not Found in Configuration`n`n**Problem:** FriendlyName not found in config`n`n`n**Solution:**`n`n1. Check spelling of FriendlyName in config`n2. Verify config JSON syntax is valid`n`n```powershell`n# Validate config JSON`nGet-Content CertDeploy-config.json | ConvertFrom-Json`n`n# List configured certificates`n(Get-Content CertDeploy-config.json | ConvertFrom-Json).Certificates | Select-Object FriendlyName`n````n`n### Access Denied to Share`n`n**Problem:** Cannot access certificate share`n`n`n**Solutions:**`n`n```powershell`n# Test share access`nTest-Path "\\certshare.domain.local\certificates"`n`n# Check share permissions`n# Ensure user has Read/Write access to the share and NTFS permissions`n`n# Use UNC path with credentials if needed`n$cred = Get-Credential`nNew-PSDrive -Name CertShare -Root "\\certshare.domain.local\certificates" -Credential $cred -PSProvider FileSystem`n````n`n### Rollback Occurred`n`n**Problem:** Deployment rolled back after health check failure`n`n`n**Solutions:**`n`n1. Investigate why health check failed`n2. Verify the certificate is correct`n3. Check application dependencies on certificate`n4. Re-run deployment after fixing issues`n`n```powershell`n# Check log file for rollback details`nGet-Content C:\Logs\CertDeploy\CertDeploy_*.log | Select-String "rollback"`n`n# Verify certificate on target`n.\CertDeploy.ps1 -Command verify -FriendlyName webapp-frontend -Server WEB01.domain.local`n`n`n`n## Exit Codes`n`n| Exit Code | Meaning |`n|-----------|---------|`n| 0 | Success |`n| 1 | Error occurred |`n`n`n## Logging`n`nLogs are written to JSON files in the configured logging path (default: `C:\Logs\CertDeploy\`).`n`nLog format:`n`n```json`n{"Timestamp":"2025-01-15 14:30:45","Level":"INFO","Message":"Certificate imported on WEB01"}`n````n`nLog levels:`n`n- `INFO`: Normal operations`n- `WARNING`: Non-critical issues`n- `ERROR`: Failures requiring attention`n`- `DEBUG`: Detailed diagnostic information`n- `AUDIT`: Important state changes`n`n## Best Practices`n`n1. **Always run audit before any changes**`n2. **Use TestMode for initial deployments**`n3. **Verify after every deploy**`n4. **Keep configuration in version control**`n5. **Rotate PFX passwords regularly**`n6. **Review logs after each operation**`n7. **Generate reports for audit trails**`n`n## Support`n`nFor issues, questions, or contributions, please refer to your internal documentation or contact the CertDeploy team.`n`n## License`n`nInternal tool - licensed for use within your organization.`n